{{- $tags := .Tags -}}
{{- $color := .Data "color" -}}
{{- $songs := .Children.Top60.ByRank.Slice -}}
{{- $canEdit := .UserCan "edit" -}}

<div class="page" hx-get="/{{.StreamID}}" hx-trigger="refreshPage from:window" hx-push-url="false" hx-target="main" hx-swap="innerHTML">

	<style>

		body {

		{{ if ne nil $color.body -}}
			--body-background: {{$color.body}};
		{{- end }}

		{{ if ne nil $color.page -}}
			{{- $pageColor := parseColor $color.page -}}
			--page-background: {{$color.page}};
			--page-border: {{$pageColor.Darken 10}};
			--heading-color: {{$pageColor.Text}};
			--text-color: {{$pageColor.TextExt}};

			{{if $pageColor.IsLight }}
				--white:  rgb(255, 255, 255);
				--gray00: rgb(255, 255, 255);
				--gray01: rgba(0, 0, 0, 0.01);
				--gray02: rgba(0, 0, 0, 0.02);
				--gray03: rgba(0, 0, 0, 0.03);
				--gray04: rgba(0, 0, 0, 0.04);
				--gray05: rgba(0, 0, 0, 0.05);
				--gray10: rgba(0, 0, 0, 0.10);
				--gray15: rgba(0, 0, 0, 0.15);
				--gray20: rgba(0, 0, 0, 0.20);
				--gray30: rgba(0, 0, 0, 0.30);
				--gray40: rgba(0, 0, 0, 0.40);
				--gray50: rgba(0, 0, 0, 0.50);
				--gray60: rgba(0, 0, 0, 0.60);
				--gray70: rgba(0, 0, 0, 0.70);
				--gray80: rgba(0, 0, 0, 0.80);
				--gray90: rgba(0, 0, 0, 0.90);
				--gray100: rgb(0, 0, 0);
				--black:   rgb(0, 0, 0);
			{{- else }}
				--white:  rgb(0, 0, 0) ;
				--gray00: rgb(0, 0, 0) ;
				--gray01: rgba(255, 255, 255, 0.01);
				--gray02: rgba(255, 255, 255, 0.02);
				--gray03: rgba(255, 255, 255, 0.03);
				--gray04: rgba(255, 255, 255, 0.04);
				--gray05: rgba(255, 255, 255, 0.05);
				--gray10: rgba(255, 255, 255, 0.10);
				--gray15: rgba(255, 255, 255, 0.15);
				--gray20: rgba(255, 255, 255, 0.20);
				--gray30: rgba(255, 255, 255, 0.30);
				--gray40: rgba(255, 255, 255, 0.40);
				--gray50: rgba(255, 255, 255, 0.50);
				--gray60: rgba(255, 255, 255, 0.60);
				--gray70: rgba(255, 255, 255, 0.70);
				--gray80: rgba(255, 255, 255, 0.80);
				--gray90: rgba(255, 255, 255, 0.90);
				--gray100: rgb(255, 255, 255);
				--black:   rgb(255, 255, 255);
			{{- end -}}

		{{- end }}

		{{ if ne nil $color.button -}}
			{{- $buttonColor := parseColor $color.button -}}
			{{- $buttonText := $buttonColor.Text }}
			{{- $buttonColorHover := ($buttonColor.Lighten 10) -}}
			{{- $buttonTextHover := $buttonColorHover.Text }}
			{{- $buttonColor := $color.button -}}

			--button-primary-background: {{$buttonColor}};
			--button-primary-background-hover: {{$buttonColorHover}};
			--button-primary-color: {{$buttonText}};
			--button-primary-color-hover: {{$buttonTextHover}};
			--link-color: {{$buttonColor}};
			--link-color-hover: {{$buttonColorHover}};
		{{- end }}

		#media-controls > .playing-show,
		#media-controls.PLAYING > .playing-hide {
			display: none;
		}

		#media-controls.PLAYING > .playing-show,
		#media-controls > .playing-hide {
			display: initial;
		}

	</style>

	<!-- First Row: Album Name and Artwork -->
	<div class="md:flex-row width-100-percent align-center md:align-left">
		<img src="{{.IconURL}}" class="width-480 md:width-256 aspect-square" style="border:solid 1px var(--black); object-fit:cover;">
		<div class="md:show width-32"></div>
		<div class="flex-grow-1">
			<h1 class="margin-top">{{.Label}}</h1>
			<h2 class="margin-vertical-none">
				<a href="/@{{.ParentID}}/albums">{{.AttributedTo.Name}}</a> 
				{{ if ne nil (.Data "year") -}}
					&middot; {{.Data "year"}}
				{{- end -}}
			</h2>
			<div>
				{{- range $index, $tag := $tags -}}
					{{- if eq "Hashtag" $tag.Type}}
						{{- if ne 0 $index -}},&nbsp;{{- end -}}
						<a href="{{$tag.Href}}">{{$tag.Name}}</a>
					{{- end -}}
				{{- end -}}
			</div>
			<div class="margin-vertical"></div>
			<div id="media-controls" class="margin-vertical-lg">
				<button hx-on:click="PlayFirst()" class="primary playing-hide">{{icon "play-fill"}} Play</button>
				<button hx-on:click="PlayPrevious()" class="primary playing-show margin-right-none">{{icon "skip-backward-fill"}}</button>
				<button hx-on:click="Pause()" class="primary playing-show margin-right-none">{{icon "pause-fill"}}</button>
				<button hx-on:click="PlayNext()" class="primary playing-show">{{icon "skip-forward-fill"}}</button>
				{{- if (.Data "links").NotEmpty -}}
					<button hx-get="/{{.StreamID}}/links">{{icon "cloud"}} Links</button>
				{{- end -}}
			</div>

		</div>
	</div>

	<!-- Second Row: -->
	<div class="md:flex-row-reverse margin-top-lg">

		<!-- Song List -->
		<div class="flex-grow-1">
			<table class="table">
				{{- range $index, $song := $songs -}}
					{{- $isplayable := ne nil $song.Data.attachmentId -}}
					<tr id="track-{{$index}}" class="hover-trigger" 

						{{ if $isplayable -}} 
							role="button"
						{{- end -}}>

						<td nowrap class="align-right" {{ if $isplayable}}hx-on:click="Toggle({{$index}})"{{end}}>
							<span class="margin-right text-gray">
								{{- if $isplayable -}}
									<span class="hover-show">{{icon "play-fill"}}</span>
									{{- if eq $song.Data.featured true -}}
										<span class="hover-hide">{{icon "star-fill"}}</span>
									{{- end -}}
								{{- else -}}
									{{- if eq $song.Data.featured true -}}
										{{icon "star-fill"}}
									{{- end -}}
								{{- end -}}
							</span>
							<span class="hide sm:show">{{add $index 1}}.</span>
						</td>
						<td class="width-100-percent" {{ if $isplayable}}hx-on:click="Toggle({{$index}})"{{end}}>
							{{$song.Label}}
							{{ if eq true $song.Data.explicit }}<span class="text-gray text-xs margin-left-sm">{{icon "explicit-fill"}}</span>{{ end }}
						</td>
						<td nowrap class="align-right" {{ if $isplayable}}hx-on:click="Toggle({{$index}})"{{end}}>
							{{- $song.Data.length -}}
						</td>
						<td nowrap>
							{{- if .Data.links.NotEmpty -}}
								<button hx-get="/{{$song.StreamID}}/links">{{icon "cloud"}}</button>
							{{- end -}}
						</td>
						{{- if $canEdit -}}
							<td nowrap>
								<button hx-get="/{{$song.StreamID}}/edit" class="text-xs margin-right-none margin-left-sm">Edit</button>
							</td>
						{{- end -}}
					</tr>
				{{- end -}}
		
			</table>
			<div class="margin-vertical-lg text-sm">
				{{- if .UserCan "add-song" -}}
					<button hx-get="/{{.StreamID}}/add-song">{{icon "add"}} Add Song</button>
				{{- end -}}
			</div>

		</div>

		<!-- Album Notes and Manager Actions -->
		<div class="md:width-256 margin-right-lg">

			{{- if ne "" .Summary -}}
				<div class="margin-bottom-lg">
					<h3>Album Notes</h3>
					{{.Summary }}
				</div>
			{{- end -}}

		</div>

	</div>

	{{- if $canEdit -}}
		<div class="pos-absolute-top-right text-sm">
			<button hx-get="/{{.StreamID}}/edit">Edit Album</button>
		</div>
	{{- end -}}

	<audio hx-on:ended="PlayNext()">
		<source id="source-mp3" type="audio/mp3">
		<source id="source-aac" type="audio/aac">
	</audio>

	<script src="/.templates/arcadium-album/javascript" preload></script>
	<script type="application/javascript">
		var playlist = [
		{{- $first := true -}}
		{{- range $index, $song := $songs -}}
			{{- if ne nil $song.Data.attachmentId -}}
				{{- if not $first -}},{{- end -}}
				{{- $first = false -}}
				{"index":{{$index}}, "url":"/{{$song.StreamID}}/attachments/{{$song.Data.attachmentId}}", "title":"{{$song.Label}}"}
			{{ end -}}
		{{- end -}}
		]
	</script>

</div>